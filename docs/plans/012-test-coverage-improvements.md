# План улучшения покрытия тестами

## Обзор
План направлен на улучшение покрытия тестами компонентов с низким покрытием, выявленных в ходе анализа результатов тестирования.

## Текущее состояние покрытия

### ✅ Отличные результаты (100% покрытие)
- `src/entities/*` - все компоненты
- `src/features/auth/guards` - 100%
- `src/features/calorie-calculation/services` - 100%
- `src/features/calorie-calculation/ui/*` - 100%
- `src/pages/dashboard/ui` - 100%
- `src/pages/login` - 100%
- `src/pages/register` - 100%
- `src/shared/lib/utils` - 100%
- `src/shared/services/telegram` - 100%
- `src/shared/services/user` - 100%
- `src/shared/ui/*` - большинство компонентов
- `src/widgets/*` - все компоненты

### ⚠️ Требуют улучшения

#### 1. `src/app/interceptors` - 57.4% statements, 42.85% branches
**Проблемы:**
- Низкое покрытие branches (42.85%)
- Недостаточное тестирование edge cases
- Отсутствуют тесты для error handling

**Целевое покрытие:** 85%+ statements, 80%+ branches

#### 2. `src/shared/services/offline-sync` - 62.96% statements
**Проблемы:**
- Средний уровень покрытия statements
- Недостаточное тестирование методов синхронизации
- Отсутствуют тесты для offline/online состояний

**Целевое покрытие:** 85%+ statements

#### 3. `src/shared/services/sw-update` - 63.15% statements, 37.5% functions
**Проблемы:**
- Очень низкое покрытие functions (37.5%)
- Недостаточное тестирование Service Worker обновлений
- Отсутствуют тесты для пользовательских действий

**Целевое покрытие:** 85%+ statements, 80%+ functions

#### 4. `src/app` - 66.66% statements, 0% functions
**Проблемы:**
- Нулевое покрытие functions
- Недостаточное тестирование app компонента
- Отсутствуют тесты для инициализации приложения

**Целевое покрытие:** 85%+ statements, 80%+ functions

## Этапы реализации

### Этап 1: Улучшение тестов interceptors
**Приоритет:** Высокий
**Время:** 2-3 часа

#### Задачи:
1. **Добавить тесты для edge cases в auth.interceptor**
   - Тестирование с невалидными токенами
   - Тестирование с истекшими токенами
   - Тестирование network errors
   - Тестирование refresh token failures

2. **Улучшить тесты token-refresh-manager**
   - Тестирование concurrent refresh requests
   - Тестирование timeout scenarios
   - Тестирование error handling
   - Тестирование cleanup logic

3. **Добавить тесты для credentials.interceptor**
   - Тестирование с различными типами запросов
   - Тестирование CORS scenarios
   - Тестирование с отсутствующими credentials

#### Ожидаемый результат:
- Statements: 85%+ (с 57.4%)
- Branches: 80%+ (с 42.85%)

### Этап 2: Улучшение тестов offline-sync service
**Приоритет:** Средний
**Время:** 2-3 часа

#### Задачи:
1. **Добавить тесты для методов синхронизации**
   - Тестирование syncData() с различными сценариями
   - Тестирование handleOfflineData() с разными типами данных
   - Тестирование cleanupOfflineData() после успешной синхронизации

2. **Добавить тесты для network states**
   - Тестирование offline/online transitions
   - Тестирование поведения при потере соединения
   - Тестирование восстановления соединения

3. **Добавить тесты для error handling**
   - Тестирование API errors при синхронизации
   - Тестирование localStorage errors
   - Тестирование timeout scenarios

#### Ожидаемый результат:
- Statements: 85%+ (с 62.96%)

### Этап 3: Улучшение тестов sw-update service
**Приоритет:** Средний
**Время:** 2-3 часа

#### Задачи:
1. **Добавить тесты для всех функций**
   - Тестирование checkForUpdates()
   - Тестирование activateUpdate()
   - Тестирование skipWaiting()
   - Тестирование handleUpdateAvailable()

2. **Добавить тесты для Service Worker events**
   - Тестирование 'updatefound' events
   - Тестирование 'controllerchange' events
   - Тестирование 'statechange' events

3. **Добавить тесты для пользовательских действий**
   - Тестирование пользовательского согласия на обновление
   - Тестирование отмены обновления
   - Тестирование автоматического обновления

#### Ожидаемый результат:
- Statements: 85%+ (с 63.15%)
- Functions: 80%+ (с 37.5%)

### Этап 4: Улучшение тестов app компонента
**Приоритет:** Низкий
**Время:** 1-2 часа

#### Задачи:
1. **Добавить тесты для функций app компонента**
   - Тестирование инициализации приложения
   - Тестирование theme toggle functionality
   - Тестирование router navigation

2. **Добавить тесты для lifecycle hooks**
   - Тестирование ngOnInit
   - Тестирование ngOnDestroy
   - Тестирование subscription management

3. **Добавить тесты для error handling**
   - Тестирование global error handling
   - Тестирование unhandled promise rejections

#### Ожидаемый результат:
- Statements: 85%+ (с 66.66%)
- Functions: 80%+ (с 0%)

## Критерии успеха

### Целевые показатели покрытия:
- **Statements**: 92%+ (с текущих 89.92%)
- **Branches**: 88%+ (с текущих 82.96%)
- **Functions**: 88%+ (с текущих 83.18%)
- **Lines**: 92%+ (с текущих 90.51%)

### Качественные критерии:
- ✅ Все новые тесты проходят в headless режиме
- ✅ Тесты покрывают edge cases и error scenarios
- ✅ Тесты используют моки для внешних зависимостей
- ✅ Тесты следуют установленным паттернам проекта
- ✅ Тесты имеют описательные названия
- ✅ Тесты изолированы и не зависят друг от друга

## Технические требования

### Инструменты и подходы:
- Использование `configureZonelessTestingModule()` для всех тестов
- Мокирование внешних зависимостей (HTTP, localStorage, Service Worker)
- Тестирование как success, так и error scenarios
- Использование Jasmine spies для проверки вызовов методов
- Тестирование signal behavior и reactive patterns

### Стандарты кода:
- Все тесты должны следовать паттернам существующих тестов
- Использование английского языка для всех строк
- Отсутствие комментариев в коде
- Строгая типизация TypeScript
- Следование принципам FSD архитектуры

## План выполнения

### Неделя 1:
- [ ] Этап 1: Улучшение тестов interceptors
- [ ] Проверка покрытия и финальные тесты

### Неделя 2:
- [ ] Этап 2: Улучшение тестов offline-sync service
- [ ] Этап 3: Улучшение тестов sw-update service
- [ ] Проверка покрытия и финальные тесты

### Неделя 3:
- [ ] Этап 4: Улучшение тестов app компонента
- [ ] Финальная проверка покрытия
- [ ] Обновление документации

## Риски и митигация

### Потенциальные риски:
1. **Сложность мокирования Service Worker API**
   - Митигация: Использование существующих паттернов мокирования
2. **Время на написание качественных тестов**
   - Митигация: Поэтапное выполнение с проверками
3. **Зависимость от внешних API в тестах**
   - Митигация: Полное мокирование всех внешних зависимостей

### Критерии остановки:
- Если покрытие не улучшается после 2 попыток на этапе
- Если тесты становятся слишком сложными для поддержки
- Если время выполнения превышает 50% от запланированного

## Заключение

Данный план направлен на систематическое улучшение покрытия тестами с фокусом на компоненты с низким покрытием. Реализация плана позволит достичь высоких стандартов качества кода и обеспечить надежность приложения.

**Общий бюджет времени:** 7-11 часов
**Ожидаемое улучшение покрытия:** +3-5% по всем метрикам
